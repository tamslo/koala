#!/bin/bash

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

python() {
  command python3 "$@"
}

pip() {
  command pip3 "$@"
}

echo ""
echo "Starting deployment"
echo ""

echo ""
echo "Checking out current version"
git --work-tree=/home/deploy/code/ --git-dir=/home/deploy/git/ checkout -f

echo ""
echo "Installing dependencies"
echo ""
cd ~/code
chmod a+x scripts/install.sh
source scripts/install.sh

echo ""
echo "Starting in production mode"
cd ~/code
chmod a+x scripts/prod-start.sh
source scripts/prod-start.sh

echo ""
echo "Deployment finished, PID is $(lsof -i:5000)"
echo ""
